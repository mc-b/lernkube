#!/bin/bash
#
#   Erstellt eine oder mehrere K8s Cluster auf einer oder mehreren Bare Metal Maschinen
#

#
#   aktuelle VMs anzeigen
#
function status
{
    vagrant status
    for file in $1/*.yaml
    do
        host=`basename $file .yaml`
        [ "${host}" = "config" ] && { continue; }
        ssh ${host} '( cd ~/lernkube ; vagrant status )'
    done
}

#
#   aktuelle VMs loeschen
#
function destroy
{
    echo 'continue and destroy VMs? ([No]/Yes): '
    read x
    [ "${x}" != "Yes" ] && { exit 1; }
    
    # master aufraeumen
    vagrant destroy -f
    rm -rf .kube .docker ssh.config data-?? master-??
    
    # VMs loeschen
    for file in $1/*.yaml
    do
        host=`basename $file .yaml`
        [ "${host}" = "config" ] && { continue; }        
        echo "remove VMs on host ${host}"
        ssh ${host} '( cd ~/lernkube ; vagrant destroy -f )'
        ssh ${host} '( cd ~/lernkube ; rm -rf .kube .docker ssh.config data-?? master-?? )'
    done
}

#
# VMs bauen
#
function up
{
    cp $1/config.yaml config.yaml
    vagrant up
    
    # remote VMs bauen
    for file in $1/*.yaml
    do
        host=`basename $file .yaml`
        [ "${host}" = "config" ] && { continue; }        
        echo "create VMs on host ${host}"
        scp $file ${host}:lernkube/config.yaml
        ssh ${host} '( cd ~/lernkube ; vagrant up )'
    done
}

#
# worker finden und joinen
#
function join
{
[ $# -lt 2 ] && { echo "missing master"; exit 1; }
vagrant ssh $2 -c "sudo kubeadm token create --print-join-command" | tr -d '\r' >join

    for file in $1/*.yaml
    do
        host=`basename $file .yaml`
        [ "${host}" = "config" ] && { continue; }        
        echo "join VMs on host ${host}"
    	scp join ${host}:lernkube/data
        for h in $(ssh ${host} '( cd ~/lernkube; find .vagrant -name private_key | grep worker | cut -d/ -f 3 )')
        do
            echo ${h}
            ssh ${host} "cd ~/lernkube && vagrant ssh ${h} -c 'sudo bash -x /data/join'"
        done
	   ssh ${host} rm -f lernkube/data/join
    done
    rm -f join
}

#
# master .kube/.docker etc. finden und zippen
#
function zip
{

    for file in $1/*.yaml
    do
        host=`basename $file .yaml`
        [ "${host}" = "config" ] && { continue; }        
        echo "zip VMs on host ${host}"
        for h in $(ssh ${host} '( cd ~/lernkube; find .vagrant -name private_key | grep master | cut -d/ -f 3 )')
        do
            echo ${h}
            ssh ${host} "cd ~/lernkube && zip -r - ${h}" | cat - >${h}.zip
        done
    done
}

########################
#
#   Hauptprogramm

if  [ $# -lt 2 ]
then
    echo 'clusteradm [status|destroy|up|join] template master'
    exit 1
fi

func=$1
shift
cd ~/lernkube
[ ! -f $1/config.yaml ] && { echo "missing $1/config.yaml"; exit 1; }

${func} $*

